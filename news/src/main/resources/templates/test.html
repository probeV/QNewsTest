<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Qraft ë‰´ìŠ¤ WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        .messages {
            border: 1px solid #ddd;
            height: 400px;
            overflow-y: scroll;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8f9fa;
        }
        .message {
            margin: 5px 0;
            padding: 8px;
            border-left: 3px solid #007bff;
            background-color: white;
        }
        .message-header {
            font-weight: bold;
            color: #007bff;
            font-size: 0.9em;
        }
        .message-body { margin-top: 5px; }
        .controls { margin: 10px 0; }
        .controls button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-connect { background-color: #28a745; color: white; }
        .btn-disconnect { background-color: #dc3545; color: white; }
        .btn-clear { background-color: #6c757d; color: white; }
        .stats {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
<h1>ğŸ”” Qraft ë‰´ìŠ¤ ì‹¤ì‹œê°„ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h1>

<div id="status" class="status disconnected">ğŸ”´ ì—°ê²° ì•ˆë¨</div>

<div class="controls">
    <button class="btn-connect" onclick="connect()">ğŸ”Œ ì—°ê²°</button>
    <button class="btn-disconnect" onclick="disconnect()">âŒ ì—°ê²° í•´ì œ</button>
    <button class="btn-clear" onclick="clearMessages()">ğŸ—‘ï¸ ë©”ì‹œì§€ ì§€ìš°ê¸°</button>
</div>

<div class="stats">
    <strong>ğŸ“Š í†µê³„:</strong>
    ë°›ì€ ë©”ì‹œì§€: <span id="messageCount">0</span>ê°œ |
    ì—°ê²° ì‹œê°„: <span id="connectionTime">-</span> |
    ë§ˆì§€ë§‰ ìˆ˜ì‹ : <span id="lastReceived">-</span>
</div>

<div>
    <h3>ğŸ“¨ ë°›ì€ ë‰´ìŠ¤ ë©”ì‹œì§€:</h3>
    <div id="messages" class="messages">
        <div style="color: #6c757d; text-align: center; padding: 20px;">
            ì•„ì§ ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤. ì—°ê²° í›„ ë‰´ìŠ¤ë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
        </div>
    </div>
</div>

<script>
    let stompClient = null;
    let messageCount = 0;
    let connectionStartTime = null;

    const statusDiv = document.getElementById('status');
    const messagesDiv = document.getElementById('messages');
    const messageCountSpan = document.getElementById('messageCount');
    const connectionTimeSpan = document.getElementById('connectionTime');
    const lastReceivedSpan = document.getElementById('lastReceived');

    function updateStatus(status, className) {
        statusDiv.textContent = status;
        statusDiv.className = 'status ' + className;
    }

    function connect() {
        console.log('ğŸ”„ ì—°ê²° ì‹œë„ ì¤‘...');
        updateStatus('ğŸŸ¡ ì—°ê²° ì¤‘...', 'connecting');

        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        // STOMP ë””ë²„ê·¸ ë¡œê·¸ ë¹„í™œì„±í™”
        stompClient.debug = function(str) {
            console.log('STOMP: ' + str);
        };

        stompClient.connect({}, function(frame) {
            console.log('âœ… ì—°ê²° ì„±ê³µ: ' + frame);
            updateStatus('ğŸŸ¢ ì—°ê²°ë¨ - ë‰´ìŠ¤ ìˆ˜ì‹  ëŒ€ê¸°ì¤‘', 'connected');
            connectionStartTime = new Date();
            updateConnectionTime();

            // /ws/news í† í”½ êµ¬ë…
            stompClient.subscribe('/ws/news', function(message) {
                console.log('ğŸ“¨ ë©”ì‹œì§€ ë°›ìŒ:', message);
                try {
                    const newsData = JSON.parse(message.body);
                    showNewsMessage(newsData);
                } catch (e) {
                    console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', e);
                    showMessage('ì˜¤ë¥˜: JSON íŒŒì‹± ì‹¤íŒ¨ - ' + message.body, 'error');
                }
            });

            // ì—°ê²° í›„ ì²« ë©”ì‹œì§€ í‘œì‹œ
            clearMessages();
            showMessage('ğŸ‰ WebSocket ì—°ê²° ì™„ë£Œ! ì‹¤ì‹œê°„ ë‰´ìŠ¤ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.', 'info');

        }, function(error) {
            console.error('âŒ ì—°ê²° ì‹¤íŒ¨:', error);
            updateStatus('ğŸ”´ ì—°ê²° ì‹¤íŒ¨: ' + error, 'disconnected');
            showMessage('âŒ ì—°ê²° ì‹¤íŒ¨: ' + error, 'error');
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(function() {
                console.log('ğŸ”Œ ì—°ê²° í•´ì œë¨');
                updateStatus('ğŸ”´ ì—°ê²° í•´ì œë¨', 'disconnected');
                connectionStartTime = null;
                updateConnectionTime();
                showMessage('ğŸ”Œ WebSocket ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            });
        }
    }

    function showNewsMessage(newsData) {
        messageCount++;
        const timestamp = new Date().toLocaleTimeString('ko-KR');

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.innerHTML = `
                <div class="message-header">
                    ğŸ“° [${timestamp}] ë‰´ìŠ¤ ID: ${newsData.id || 'N/A'}
                </div>
                <div class="message-body">
                    <strong>ì œëª©:</strong> ${newsData.title || 'N/A'}<br>
                    <strong>ë‚´ìš©:</strong> ${newsData.body || newsData.content || 'N/A'}<br>
                    <strong>ë°œí–‰ì‹œê°„:</strong> ${newsData.publishedAt || 'N/A'}
                </div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        // í†µê³„ ì—…ë°ì´íŠ¸
        updateStats(timestamp);
    }

    function showMessage(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString('ko-KR');
        const icon = type === 'error' ? 'âŒ' : type === 'info' ? 'â„¹ï¸' : 'ğŸ“¨';

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message';
        messageDiv.innerHTML = `
                <div class="message-header">
                    ${icon} [${timestamp}] ì‹œìŠ¤í…œ ë©”ì‹œì§€
                </div>
                <div class="message-body">${message}</div>
            `;

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function updateStats(lastReceived) {
        messageCountSpan.textContent = messageCount;
        lastReceivedSpan.textContent = lastReceived || '-';
    }

    function updateConnectionTime() {
        if (connectionStartTime) {
            const now = new Date();
            const diff = Math.floor((now - connectionStartTime) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;
            connectionTimeSpan.textContent = `${minutes}ë¶„ ${seconds}ì´ˆ`;
        } else {
            connectionTimeSpan.textContent = '-';
        }
    }

    function clearMessages() {
        messagesDiv.innerHTML = '';
        messageCount = 0;
        updateStats();
    }

    // 1ì´ˆë§ˆë‹¤ ì—°ê²° ì‹œê°„ ì—…ë°ì´íŠ¸
    setInterval(updateConnectionTime, 1000);

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²°
    window.onload = function() {
        console.log('ğŸš€ í˜ì´ì§€ ë¡œë“œë¨ - ìë™ ì—°ê²° ì‹œì‘');
        setTimeout(connect, 1000); // 1ì´ˆ í›„ ìë™ ì—°ê²°
    };

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° í•´ì œ
    window.onbeforeunload = function() {
        if (stompClient !== null) {
            disconnect();
        }
    };
</script>
</body>
</html>